<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2013 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
/**
 * @var Mage_Page_Block_Html_Header $this
 */
?>
<?php $FB_APP_ID = Mage::getModel('core/variable')->loadByCode('fb_app_id')->getValue('html'); ?>

<div id="fb-root"></div>

<script>
    var responseFb = {};
    window.fbAsyncInit = function () {
        FB.init({
            appId: '<?php echo $FB_APP_ID?>',
            cookie: true, // enable cookies to allow the server to access
            // the session
            xfbml: true, // parse social plugins on this page
            version: 'v2.10' // use graph api version 2.10
        });

        FB.getLoginStatus(function (response) {
            responseFb = response;
        });
    };
    (function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s);
        js.id = id;
        js.src = "//connect.facebook.net/vi_VN/sdk.js#xfbml=1&version=v2.10&appId=" + '<?php echo $FB_APP_ID?>';
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));

    if (document.referrer) {
        if (document.referrer.search("google") > 0) {
            document.cookie = "c_utmsource=google; path=/";
        } else if (document.referrer.search("facebook") > 0) {
            document.cookie = "c_utmsource=facebook; path=/";
        }
    }

    if (navigator.userAgent.match(/Android/i)
        || navigator.userAgent.match(/webOS/i)
        || navigator.userAgent.match(/iPhone/i)
        || navigator.userAgent.match(/iPad/i)
        || navigator.userAgent.match(/iPod/i)
        || navigator.userAgent.match(/BlackBerry/i)
        || navigator.userAgent.match(/Windows Phone/i)
    ) {
        document.cookie = "_c_agent=mobile; path=/";
    }
    else {
        document.cookie = "_c_agent=desktop; path=/";
    }
</script>

<div class="header" style="z-index:1002">
    <div class="header-container">
        <div class="header-top">
            <div class="row tekshop-topbar fix-top">
                <div class="container">
                    <div class="col-md-2 col-sm-2 col-xs-2 no-padding">
                        <?php if ($this->getIsHomePage()): ?>
                            <div class="logo"><strong><?php echo $this->getLogoAlt() ?></strong>
                                <a href="<?php echo $this->getUrl('') ?>"
                                   title="<?php echo $this->getLogoAlt() ?>" class="logo">
                                    <img src="<?php echo $this->getSkinUrl('images/logotekshop.png') ?>"
                                         class="logo-img logo-normal"
                                         alt="<?php echo $this->getLogoAlt() ?>"/>
<!--                                    <img src="--><?php //echo $this->getSkinUrl('images/logomobile.png') ?><!--"-->
<!--                                         class="logo-img logo-mobile"-->
<!--                                         alt="--><?php //echo $this->getLogoAlt() ?><!--"/>-->
                                    <img src="<?php echo $this->getSkinUrl('images/logo.png') ?>"
                                         class="logo-img logo-mobile"
                                         alt="<?php echo $this->getLogoAlt() ?>"/>
                                </a>
                            </div>
                        <?php else: ?>
                            <div class="logo"><strong><?php echo $this->getLogoAlt() ?></strong>
                                <a href="<?php echo $this->getUrl('') ?>"
                                   title="<?php echo $this->getLogoAlt() ?>" class="logo">
                                    <img src="<?php echo $this->getSkinUrl('images/logotekshop.png') ?>"
                                         class="logo-img logo-normal"
                                         alt="<?php echo $this->getLogoAlt() ?>"/>
<!--                                    <img src="--><?php //echo $this->getSkinUrl('images/logomobile.png') ?><!--"-->
<!--                                         class="logo-img logo-mobile"-->
<!--                                         alt="--><?php //echo $this->getLogoAlt() ?><!--"/>-->
                                    <img src="<?php echo $this->getSkinUrl('images/logo.png') ?>"
                                         class="logo-img logo-mobile"
                                         alt="<?php echo $this->getLogoAlt() ?>"/>
                                </a>
                            </div>
                        <?php endif ?>
                    </div>
                    <div class="pv-addition-content">
                        <a href="tel:19001835">
                            <div class="pv-call">
                                <img src="<?php echo $this->getSkinUrl('images/Call.svg') ?>" alt="Tổng đài Phong Vũ" />
                            </div>
                        </a>
                        <div class="pv-message">
                            <a href="https://m.me/phongvuvietnam" target="_blank">
                                <img src="<?php echo $this->getSkinUrl('images/Messenger.png') ?>" alt="Chat Ngay" />
                            </a>
                        </div>
                    </div>
                    <div class="col-md-10 col-sm-8 col-xs-8 text-left no-padding">
                        <div class="top-bar-menu text-right">
                            <?php echo $this->getChildHtml('topSearch') ?>
                            <div id="shopping-cart-header">
                                <?php echo $this->getChildHtml('headerCart') ?>
                            </div>
                        </div>
                        <?php echo $this->getChildHtml('topMenu') ?>
                        <div class="clearfix"></div>
                    </div>
                </div>
            </div>

            <?php
            $storeCode = Mage::app()->getStore()->getCode();
            $action = Mage::app()->getFrontController()->getAction()->getFullActionName();
            ?>
            <?php if ($action == 'cms_index_index'): ?>
                <div class="container">
                    <div class="row mt-160">
                        <!-- New Owl Carousel-->
                        <?php
                        echo $this->getLayout()->createBlock('cms/block')->setBlockId('slider_' . $storeCode)->toHtml();
                        ?>
                        <!-- End New Owl Carousel-->
                        <div class="hotdeal-block hidden-mobile">
                            <?php
                            echo $this->getLayout()->createBlock('cms/block')->setBlockId('hotdeal_' . $storeCode)->toHtml();
                            ?>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <?php
                    echo $this->getLayout()->createBlock('cms/block')->setBlockId('brand_tekshop')->toHtml();
                    ?>
                </div>
            <?php endif; ?>
        </div>

    </div>
</div>
<div id="loginModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg">
        <!-- Modal content-->
        <div class="modal-content modal-login modal-mobile">
            <div class="modal-body ">
                <button type="button" class="close-button close-lg" data-dismiss="modal" aria-hidden="true"
                        style="margin-top: -10px;">×
                </button>
                <div class="row">
                    <div class="col-md-8 col-md-offset-2">
                        <div class="panel panel-login modal-login" style="border: none!important;">
                            <div class="panel-heading modal-login" style="border: none!important;">
                                <div class="row">
                                    <div class="col-xs-4">
                                        <a class="lg-tabs active" id="login-form-link">Đăng nhập</a>
                                    </div>
                                    <div class="col-xs-4">
                                        <a class="lg-tabs" id="register-form-link">Đăng ký</a>
                                    </div>
                                    <div class="col-xs-4">
                                        <a class="lg-tabs" id="link-form-link">Liên kết</a>
                                    </div>
                                </div>
                            </div>
                            <div class="panel-body modal-login">
                                <div class="row">
                                    <div class="col-lg-8 col-md-offset-2">
                                        <form id="login-form" role="form" style="display: block;">
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <img src="<?php echo $this->getSkinUrl('images/logo.png') ?>"
                                                         class="logo-img" alt="TekShop">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="text-center loading-login" title="Đang tải"
                                                     style="display: none">
                                                    <img src="<?php echo $this->getSkinUrl('images/loading.gif') ?>">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <span class="error-message" id="error-login"></span>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <input type="text" name="telephone" id="telephone-login" tabindex="1"
                                                       class="form-control" placeholder="Số điện thoại" value=""
                                                       pattern="(\\+84|0)\\d{9,10}">
                                            </div>
                                            <div class="form-group">
                                                <input type="password" name="password" id="password-login" tabindex="2"
                                                       class="form-control" placeholder="Mật khẩu"
                                                       onkeypress="handleEnterLogin(event)">
                                            </div>
                                            <div class="form-group">
                                                <div class="row">
                                                    <div class="col-sm-6 col-sm-offset-3">
                                                        <button type="button" name="login-submit" id="login-submit"
                                                                tabindex="4" class="form-control btn btn-login"> Đăng
                                                            nhập
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="row">
                                                    <div class="col-lg-12">
                                                        <div class="text-center">
                                                            <span style="cursor: pointer" tabindex="5"
                                                                  class="forgot-password">Quên mật
                                                                khẩu?</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="strike">
                                                <span>Hoặc đăng nhập bằng</span>
                                            </div>
                                            <div class="form-group" style="margin-top: 10px;">
                                                <div class="row">
                                                    <div class="col-sm-6 col-sm-offset-3">
                                                        <button type="button" tabindex="4"
                                                                class="form-control btn btn-facebook"
                                                                onclick="checkLoginState()"> FACEBOOK
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                        <form id="register-form" role="form" style="display: none;">
                                            <div class="form-group">
                                                <div class="text-center load-register" style="display: none">
                                                    <img src="<?php echo $this->getSkinUrl('images/loading.gif') ?>">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <span class="error-message" id="error-registry"></span>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <input type="text" name="email" id="register-name" tabindex="1"
                                                       class="form-control" placeholder="Tên" value="">
                                            </div>
                                            <div class="form-group">
                                                <input type="email" name="email" id="register-email" tabindex="1"
                                                       class="form-control" placeholder="Địa chỉ Email" value="">
                                            </div>
                                            <div class="form-group">
                                                <input type="text" name="telephone" id="register-telephone" tabindex="1"
                                                       class="form-control" placeholder="Số điện thoại" value=""
                                                       pattern="(\\+84|0)\\d{9,10}">
                                            </div>
                                            <div class="form-group">
                                                <input type="password" name="password" id="register-password"
                                                       tabindex="2" class="form-control" placeholder="Mật khẩu">
                                            </div>
                                            <div class="form-group">
                                                <input type="password" name="confirm-password"
                                                       id="register-confirm-password" tabindex="2" class="form-control"
                                                       placeholder="Nhập lại mật khẩu"
                                                       onkeypress="handleEnterRegister(event)">
                                            </div>
                                            <div class="form-group">
                                                <div class="row">
                                                    <div class="col-sm-6 col-sm-offset-3">
                                                        <button type="button" name="register-submit"
                                                                id="register-submit" tabindex="4"
                                                                class="form-control btn btn-register"> Đăng ký
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                        <form id="link-form" role="form" style="display: none;">
                                            <div class="form-group">
                                                <div class="text-center load-link" style="display: none">
                                                    <img src="<?php echo $this->getSkinUrl('images/loading.gif') ?>">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <span class="error-message" id="error-link"></span>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <span class="forget-text">Vui lòng nhập số điện thoại:</span>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <input type="text" name="telephone" id="link-telephone" tabindex="1"
                                                       class="form-control" placeholder="Số điện thoại" value=""
                                                       onkeypress="handleEnterLink(event)"
                                                       pattern="(\\+84|0)\\d{9,10}">
                                            </div>
                                            <div class="form-group">
                                                <div class="row">
                                                    <div class="col-sm-6 col-sm-offset-3">
                                                        <button type="button" name="link-submit"
                                                                id="link-submit" tabindex="4"
                                                                class="form-control btn btn-register"> Liên kết
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="forgetPassword" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg" style="margin-top: 15%!important;">
        <div class="modal-content modal-login">
            <div class="modal-body">
                <button type="button" class="close-button close" data-dismiss="modal" aria-hidden="true"
                        style="margin-top: -10px;">×
                </button>
                <div class="row">
                    <div class="col-md-6 col-md-offset-3">
                        <div class="panel panel-login modal-login" style="border: none!important;">
                            <div class="panel-heading modal-login" style="border: none!important;">
                                <div class="row">
                                    <div class="col-xs-12">
                                        <a href="#" class="active" id="forget-title">Quên mật khẩu</a>
                                    </div>
                                </div>
                            </div>
                            <div class="panel-body modal-login">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <form id="telephone-form" role="form" style="display: block;">
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <span class="forget-text">Vui lòng nhập số điện thoại:</span>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="text-center load-forget" style="display: none">
                                                    <img src="<?php echo $this->getSkinUrl('images/loading.gif') ?>">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <span class="error-message" id="error-forget"></span>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <input type="text" name="telephone-forget" id="telephone-forget"
                                                       tabindex="1" class="form-control" placeholder="Số điện thoại"
                                                       value=""
                                                       onkeypress='handleEnterForget(event)'>
                                            </div>
                                            <div class="form-group">
                                                <div class="row">
                                                    <div class="col-sm-6 col-sm-offset-3">
                                                        <button type="button" name="forget-submit" id="forget-submit"
                                                                tabindex="4" class="form-control btn btn-login"> Gửi mã
                                                            xác nhận
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                        <form id="otp-form" role="form" style="display: none;">
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <span class="forget-text">Mã xác thực đã được gửi về: <span
                                                                id="forget-tele-show"></span></span>
                                                </div>
                                                <div class="text-center">
                                                    <span class="forget-text">Vui lòng nhập mã xác thực:</span>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="text-center load-otp1" style="display: none">
                                                    <center>
                                                        <img src="<?php echo $this->getSkinUrl('images/loading.gif') ?>">
                                                    </center>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <span class="error-message" id="error-forget-otp"></span>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <input type="hidden" name="customer_id" id="customer_id_otp">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <input type="text" name="otp-confirm" id="otp-confirm" tabindex="1"
                                                       class="form-control" placeholder="Mã xác thực" value="">
                                            </div>
                                            <div class="form-group">
                                                <div class="row">
                                                    <div class="col-sm-12">
                                                        <div class="row">
                                                            <div class="col-sm-6">
                                                                <button type="button" name="repassword-resend"
                                                                        id="repassword-resend" tabindex="4"
                                                                        class="form-control btn btn-login"> Gửi lại
                                                                </button>
                                                            </div>
                                                            <div class="col-sm-6">
                                                                <button type="button" name="repassword-submit-otp"
                                                                        id="repassword-submit-otp" tabindex="4"
                                                                        class="form-control btn btn-login"> Xác nhận
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                        <form id="passwordConfirmForm" role="form" style="display: none;">
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <span class="forget-text">Xin chào: <span
                                                                id="forget-name-show"></span></span>
                                                </div>
                                                <div class="text-center">
                                                    <span class="forget-text"><span
                                                                id="forget-email-show"></span></span>
                                                </div>
                                                <div class="text-center">
                                                    <span class="forget-text">Vui lòng nhập lại mật khẩu mới:</span>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="text-center load-forget-pass" style="display: none">
                                                    <img src="<?php echo $this->getSkinUrl('images/loading.gif') ?>">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <span class="error-message" id="error-reset-password"></span>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <input type="hidden" name="customer_id" id="customer_id_reset">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <input type="password" name="re-password" id="re-password" tabindex="2"
                                                       class="form-control" placeholder="Mật khẩu">
                                            </div>
                                            <div class="form-group">
                                                <input type="password" name="re-password" id="reconfirm-password"
                                                       tabindex="2" class="form-control"
                                                       placeholder="Nhập lại mật khẩu"
                                                       onkeypress="handleEnterResetPw(event)">
                                            </div>
                                            <div class="form-group">
                                                <div class="row">
                                                    <div class="col-sm-6 col-sm-offset-3">
                                                        <button type="button" name="repassword-submit"
                                                                id="repassword-submit" tabindex="4"
                                                                class="form-control btn btn-login"> Tạo mật khẩu mới
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="linkAccountModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg" style="margin-top: 10%">
        <div class="modal-content modal-login">
            <div class="modal-body">
                <button type="button" class="close-button close" data-dismiss="modal" aria-hidden="true"
                        style="margin-top: -10px;">×
                </button>
                <div class="row">
                    <div class="col-md-6 col-md-offset-3">
                        <div class="panel panel-login modal-login" style="border: none!important;">
                            <div class="panel-heading modal-login" style="border: none!important;">
                                <div class="row">
                                    <div class="col-xs-12">
                                        <a href="#" class="active" id="forget-title">Liên kết tài khoản</a>
                                    </div>
                                </div>
                                <hr>
                            </div>
                            <div class="panel-body modal-login">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <form id="link-otp-form" role="form" style="display: block;">
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <span class="forget-text">Mã xác nhận đã được gửi về: <span
                                                                id="linkTele"></span></span><br>
                                                    <span class="forget-text">Vui lòng nhập mã xác nhận: </span>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="text-center load-otp2" style="display: none">
                                                    <img src="<?php echo $this->getSkinUrl('images/loading.gif') ?>">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <span class="error-message" id="error-linkAcc"></span>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <input type="hidden" name="customer_id" id="customer_id_otp_link">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <input type="text" name="link-otp" id="link-otp"
                                                       tabindex="1" class="form-control"
                                                       value="">
                                            </div>
                                            <div class="form-group">
                                                <div class="row">
                                                    <div class="col-sm-12">
                                                        <div class="row">
                                                            <div class="col-sm-6">
                                                                <button type="button" name="linkAcc-resend"
                                                                        id="linkAcc-resend" tabindex="4"
                                                                        class="form-control btn btn-register"> Gửi lại
                                                                </button>
                                                            </div>
                                                            <div class="col-sm-6">
                                                                <button type="button" name="linkAcc-submit-otp"
                                                                        id="linkAcc-submit-otp" tabindex="4"
                                                                        class="form-control btn btn-register"> Xác nhận
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                        <form id="link-update-form" role="form" style="display: none;">
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <span class="forget-text">Vui lòng cập nhật thông tin tài khoản:</span><br>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <span class="error-message" id="error-link-update"></span>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <input type="hidden" name="customer_id" id="customer_id_link">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <input type="hidden" name="linkAcc-telephone"
                                                       id="linkAcc-telephone">
                                                <input type="text" class="form-control" name="linkAcc-name"
                                                       id="linkAcc-name" placeholder="Tên">
                                            </div>
                                            <div class="form-group">
                                                <input type="email" class="form-control" name="linkAcc-email"
                                                       id="linkAcc-email" placeholder="Email">
                                            </div>
                                            <div class="form-group">
                                                <input type="password" class="form-control" name="linkAcc-password"
                                                       id="linkAcc-password" placeholder="Mật khẩu">
                                            </div>
                                            <div class="form-group">
                                                <input type="password" class="form-control"
                                                       name="linkAcc-confirmPassword" id="linkAcc-confirmPassword"
                                                       placeholder="Nhập lại mật khẩu"
                                                       onkeypress="handleEnterSubmitLink(event)">
                                            </div>
                                            <div class="form-group">
                                                <div class="row">
                                                    <div class="col-sm-6 col-sm-offset-3">
                                                        <button type="button" name="linkAcc-submit"
                                                                id="linkAcc-submit" tabindex="4"
                                                                class="form-control btn btn-register"> Cập nhật
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="loginFBModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg" style="margin-top: 10%">
        <div class="modal-content modal-login">
            <div class="modal-body ">
                <button type="button" class="close-button close" data-dismiss="modal" aria-hidden="true"
                        style="margin-top: -10px;">×
                </button>
                <div class="row">
                    <div class="col-md-6 col-md-offset-3">
                        <div class="panel panel-login modal-login" style="border: none!important;">
                            <div class="panel-body modal-login">
                                <div class="row">
                                    <div class="col-lg-12 fb-confirm-header">
                                        Xin chào, <span id="fbname"></span>
                                        <p> Vui lòng cập nhật thông tin</p>
                                    </div>
                                    <form class="fb-update-profile" id="login-form-01" role="form">
                                        <div class="form-group">
                                            <div class="text-center update-profile-load-fb" style="display: none">
                                                <img src="<?php echo $this->getSkinUrl('images/loading.gif') ?>">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <div class="text-center">
                                                <span class="error-message" id="error-confirm-facebook"></span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <input type="hidden" name="registryfb-name" id="registryfb-name"
                                                   tabindex="1"
                                                   class="form-control" value="" placeholder="Tên">
                                        </div>
                                        <div class="form-group">
                                            <input type="hidden" name="facebook_id" id="inputFb" tabindex="1"
                                                   class="form-control" value="">
                                            <input type="text" name="telephone" id="fb-login-telephone" tabindex="1"
                                                   class="form-control" placeholder="Số điện thoại" value=""
                                                   onkeypress='handleLoginFb(event)'>
                                        </div>
                                        <div class="form-group">
                                            <div class="row">
                                                <div class="col-sm-6 col-sm-offset-3">
                                                    <button type="button" tabindex="4"
                                                            class="form-control btn btn-login"
                                                            onclick="pushTelephoneNumber()"> Xác nhận
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                    <form id="confirm-fb-otp" role="form" style="display: none;">
                                        <div class="form-group">
                                            <div class="text-center">
                                                    <span class="forget-text">Mã xác nhận đã được gửi về: <span
                                                                id="fbOtpTele"></span></span><br>
                                                <span class="forget-text">Vui lòng nhập mã xác nhận: </span>
                                                <span class="fb_notice"></span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <div class="text-center update-otp-load-fb" style="display: none">
                                                <img src="<?php echo $this->getSkinUrl('images/loading.gif') ?>">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <div class="text-center">
                                                <span class="error-message" id="error-confirm-facebook-otp"></span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <input type="hidden" name="customer_id" id="customer_id_otp_fb">
                                            <input type="hidden" name="fb_id" id="fb_id_otp">
                                            <input type="hidden" name="registryfb-otp" id="registryfb-otp"
                                                   tabindex="1"
                                                   class="form-control" value="">
                                        </div>
                                        <div class="form-group">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <div class="row">
                                                        <div class="col-sm-6">
                                                            <button type="button" name="loginFb-resend"
                                                                    id="loginFb-resend" tabindex="4"
                                                                    class="form-control btn btn-login"> Gửi lại
                                                            </button>
                                                        </div>
                                                        <div class="col-sm-6">
                                                            <button type="button" name="loginFb-submit-otp"
                                                                    id="loginFb-submit-otp" tabindex="4"
                                                                    class="form-control btn btn-login"> Xác nhận
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="registerModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg" style="margin-top: 10%">
        <div class="modal-content modal-login">
            <div class="modal-body">
                <button type="button" class="close-button close" data-dismiss="modal" aria-hidden="true"
                        style="margin-top: -10px;">×
                </button>
                <div class="row">
                    <div class="col-md-6 col-md-offset-3">
                        <div class="panel panel-login modal-login" style="border: none!important;">
                            <div class="panel-heading modal-login" style="border: none!important;">
                                <div class="row">
                                    <div class="col-xs-12">
                                        <a href="#" class="active" id="forget-title">Đăng ký</a>
                                    </div>
                                </div>
                            </div>
                            <div class="panel-body modal-login">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <form id="register-otp-form" role="form">
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <span class="register-text">Mã xác thực đã được gửi về: <span
                                                                id="register-tele-show"></span></span>
                                                </div>
                                                <div class="text-center">
                                                    <span class="register-text">Vui lòng nhập mã xác thực:</span>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="text-center load-otp-register" style="display: none">
                                                    <center>
                                                        <img src="<?php echo $this->getSkinUrl('images/loading.gif') ?>">
                                                    </center>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <span class="error-message" id="error-register-otp"></span>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <input type="hidden" name="customer_id" id="customer_id_register">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <input type="text" name="otp-confirm-register" id="otp-confirm-register"
                                                       tabindex="1" class="form-control" placeholder="Mã xác thực"
                                                       value=""/>
                                            </div>
                                            <div class="form-group">
                                                <div class="row">
                                                    <div class="col-sm-12">
                                                        <div class="row">
                                                            <div class="col-sm-6">
                                                                <button type="button" name="register-resend"
                                                                        id="register-resend" tabindex="4"
                                                                        class="form-control btn btn-login"> Gửi lại
                                                                </button>
                                                            </div>
                                                            <div class="col-sm-6">
                                                                <button type="button" name="registry-submit-otp"
                                                                        id="registry-submit-otp" tabindex="4"
                                                                        class="form-control btn btn-login"> Xác nhận
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var $j = jQuery.noConflict();
</script>

<!--Owl carousel-->
<script>
    $j(document).ready(function () {

        var sync1 = $j("#sync1");
        var sync2 = $j("#sync2");

        sync1.owlCarousel({
            singleItem: true,
            slideSpeed: 500,
            pagination: false,
            autoPlay: true,
            navigation: true,
            navigationText: ["<i class='fa fa-chevron-left'></i>", "<i class='fa fa-chevron-right'></i>"],
            afterAction: syncPosition,
            responsiveRefreshRate: 200
        });

        sync2.owlCarousel({
            items: 5,
            itemsScaleUp: true,
            pagination: false,
            responsiveRefreshRate: 100,
            afterInit: function (el) {
                el.find(".owl-item").eq(0).addClass("synced");
            }
        });

        function syncPosition(el) {
            var current = this.currentItem;
            $j("#sync2")
                .find(".owl-item")
                .removeClass("synced")
                .eq(current)
                .addClass("synced");
            if ($j("#sync2").data("owlCarousel") !== undefined) {
                center(current)
            }
        }

        $j("#sync2").on("click", ".owl-item", function (e) {
            e.preventDefault();
            var number = $j(this).data("owlItem");
            sync1.trigger("owl.goTo", number);
        });

        function center(number) {
            var sync2visible = sync2.data("owlCarousel").owl.visibleItems;
            var num = number;
            var found = false;
            for (var i in sync2visible) {
                if (num === sync2visible[i]) {
                    var found = true;
                }
            }

            if (found === false) {
                if (num > sync2visible[sync2visible.length - 1]) {
                    sync2.trigger("owl.goTo", num - sync2visible.length + 2)
                } else {
                    if (num - 1 === -1) {
                        num = 0;
                    }
                    sync2.trigger("owl.goTo", num);
                }
            } else if (num === sync2visible[sync2visible.length - 1]) {
                sync2.trigger("owl.goTo", sync2visible[1])
            } else if (num === sync2visible[0]) {
                sync2.trigger("owl.goTo", num - 1)
            }
        }
    });
</script>
<!-- Owl carousel-->

<script>
    var win = $j(window);
    var isHomePage = '<?php echo Mage::getBlockSingleton('page/html_header')->getIsHomePage(); ?>';

    $j(window).on('resize', function () {
        var originalSearchMobileTop = 60;
        var originalFormSearchTop = 35;

        if (win.width() < 500) {
            if (!isHomePage) {
                $j('.header-container').addClass('header-mobile-height');
            }
//      Always show the searchbar
//            win.scroll(function () {
//                if (win.width() < 500) {
//                    $j('.input-text-search').css('top', originalSearchMobileTop - win.scrollTop());
//                    $j('.form-search').css('top', originalSearchMobileTop - win.scrollTop());
//                }
//                if (win.width() < 500 && $j(this).scrollTop() >= 20) {
//                    $j('.input-text-search').hide();
//                }
//                else {
//                    $j('.input-text-search').show();
//                }
//            })
        } else {
            $j('.form-search').removeAttr('style');
//            win.scroll(function () {
//                $j('.nav-normal').css('top', -win.scrollTop());
//                if ($j(this).scrollTop() >= 50) {
//                    $j('.nav-normal').hide();
//                }
//                else {
//                    $j('.nav-normal').show();
//                }
//                if (win.width() > 500 && $j(this).scrollTop() >= 60) {
//                    $j('.tekshop-topbar').addClass('shrink');
//                }
//                else {
//                    $j('.tekshop-topbar').removeClass('shrink');
//                }
//            })
        }
    }).trigger('resize');

    /** For login **/
    $j(function () {
        $j('#login-form-link').click(function (e) {
            if ($j('#register-form-link').hasClass('active')) {
                $j("#login-form").delay(100).fadeIn(100);
                $j("#register-form").fadeOut(100);
                $j('#register-form-link').removeClass('active');
                $j(this).addClass('active');
            } else {
                $j("#login-form").delay(100).fadeIn(100);
                $j("#link-form").fadeOut(100);
                $j('#link-form-link').removeClass('active');
                $j(this).addClass('active');
            }
            e.preventDefault();
        });
        $j('#register-form-link').click(function (e) {
            if ($j('#login-form-link').hasClass('active')) {
                $j("#register-form").delay(100).fadeIn(100);
                $j("#login-form").fadeOut(100);
                $j('#login-form-link').removeClass('active');
                $j(this).addClass('active');
            } else {
                $j("#register-form").delay(100).fadeIn(100);
                $j("#link-form").fadeOut(100);
                $j('#link-form-link').removeClass('active');
                $j(this).addClass('active');
            }
            e.preventDefault();
        });
        $j('#link-form-link').click(function (e) {
            if ($j('#register-form-link').hasClass('active')) {
                $j("#link-form").delay(100).fadeIn(100);
                $j("#register-form").fadeOut(100);
                $j('#register-form-link').removeClass('active');
                $j(this).addClass('active');
            } else {
                $j("#link-form").delay(100).fadeIn(100);
                $j("#login-form").fadeOut(100);
                $j('#login-form-link').removeClass('active');
                $j(this).addClass('active');
            }
        });
    });

    function validateLoginForm() {
        var telephone = $j('#telephone-login').val();
        var password = $j('#password-login').val();
        var message = '';
        if (telephone === "" || password === "") {
            message = ("Vui lòng nhập đầy đủ các trường !");
            $j('#error-login').html(message);
            return false;
        }
        else {
            if (!/^(84|0)(1\d{9}|9\d{8}|8\d{8})$/.test(telephone)) {
                message = ("Số điện thoại không hợp lệ!");
                $j('#error-login').html(message);
                return false;
            }
            if (password.length < 8) {
                message = (" Mật khẩu không hợp lệ");
                $j('#error-login').html(message);
                return false;
            }
            $j('#error-login').html("");
            return true;
        }
    }

    function handleLogin() {
        if (validateLoginForm()) {
            var data = {
                telephone: $j('#telephone-login').val(),
                password: $j('#password-login').val()
            };
            var message = '';
            $j(".loading-login").show();
            $j.ajax({
                url: "<?php echo Mage::getUrl('authentication/user/login');?>",
                type: "post",
                dataType: 'json',
                data: data,
                success: function (response) {
                    if (response.status === "account_not_exist" || response.status === "account_not_active") {
                        message = ("Số điện thoại không tồn tại trong hệ thống!");
                        $j('#error-login').html(message);
                        $j(".loading-login").hide();
                        return false;
                    }
                    else if (response.status === "password_is_invalid") {
                        message = ("Mật khẩu không chính xác. Vui lòng nhập lại!");
                        $j('#error-login').html(message);
                        $j(".loading-login").hide();
                        return false;
                    }
                    else {
                        window.location.href =
                            '<?php echo $this->getUrl('*/*/*', ['_current' => true,
                                '_use_rewrite' => true, '_store' => Mage::app()->getStore()->getId()]); ?>';
                    }
                }
            });
        }
    }

    function handleEnterLogin(e) {
        if (e.keyCode === 13) {
            handleLogin();
            e.preventDefault(); // Ensure it is only this code that rusn
            e.stopPropagation();
        }
    }

    $j('#login-submit').on('click', function (e) {
        handleLogin();
        e.preventDefault();
        e.stopPropagation();
    });
    /** End login **/

    /** For register **/
    function validateRegistryForm() {
        var name = $j('#register-name').val();
        var email = $j('#register-email').val();
        var telephone = $j('#register-telephone').val();
        var password = $j('#register-password').val();
        var confirmPass = $j('#register-confirm-password').val();
        var message = "";
        if (email === "" || telephone === "" || password === "" || confirmPass === "" || name === "") {
            message = ("Vui lòng nhập đầy đủ các trường !");
            $j('#error-registry').html(message);
            return false;
        } else {
            if (!/[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/.test(email)) {
                message = ("Địa chỉ Email không hợp lệ!");
                $j('#error-registry').html(message);
                return false;
            }
            if (!/^(84|0)(1\d{9}|9\d{8}|8\d{8})$/.test(telephone)) {
                message = ("Số điện thoại không hợp lệ!");
                $j('#error-registry').html(message);
                return false;
            }
            if (password.length < 8) {
                message = (" Mật khẩu tối thiểu phải 8 ký tự");
                $j('#error-registry').html(message);
                return false;
            }
            if (password != confirmPass) {
                message = ("Mật khẩu nhập lại không khớp!");
                $j('#error-registry').html(message);
                return false;
            }
            $j('#error-registry').html("");
            return true;
        }
    }

    function handleRegister() {
        if (validateRegistryForm()) {
            var data = {
                telephone: $j('#register-telephone').val(),
                email: $j('#register-email').val(),
                password: $j('#register-password').val(),
                name: $j('#register-name').val()
            };
            var message = '';
            $j('.load-register').show();
            $j.ajax({
                url: "<?php echo Mage::getUrl('authentication/user/register');?>",
                type: "post",
                dataType: 'json',
                data: data,
                success: function (response) {
                    if (response.status === "account_exist") {
                        message = ("Số điện thoại đã có người sử dụng. Vui lòng nhập số điện thoại khác!");
                        $j('.load-register').hide();
                        $j('#error-registry').html(message);
                    }
                    else if (response.status === "account_fb_exist") {
                        swal({
                            title: 'Liên kết?',
                            text: "Số điện thoại đã được dùng với một tài khoản facebook khác. Bạn có muốn liên kết tài khoản không?",
                            type: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#f7701e',
                            confirmButtonText: 'Đồng ý',
                            cancelButtonText: 'Huỷ'
                        }, function (isConfirm) {
                            if (isConfirm) {
                                var newdata = data;
                                newdata.customer_id = response.customer_id;
                                $j.ajax({
                                    url: "<?php echo Mage::getUrl('authentication/user/update');?>",
                                    type: "post",
                                    dataType: 'json',
                                    data: newdata,
                                    success: function (response) {
                                        window.location.href =
                                            '<?php echo $this->getUrl('*/*/*', ['_current' => true,
                                                '_use_rewrite' => true, '_store' => Mage::app()->getStore()->getId()]); ?>';
                                    }
                                });
                            }
                            else {
                                message = ("Vui lòng nhập số điện thoại khác!");
                                $j('.load-register').hide();
                                $j('#error-registry').html(message);
                            }
                        });
                    }
                    else if (response.status === "created" || response.status === 'account_not_active') {
                        $j('#loginModal').modal('hide');
                        $j('body').removeClass('modal-open');
                        $j('#registerModal').modal();
                        $j('#customer_id_register').val(response.customer_id);
                        $j(".load-register").hide();
                        $j('#error-registry').html("");
                        $j("#register-tele-show").html($j('#register-telephone').val());
                    }
                }
            });
        }
    }

    $j('#otp-confirm-register').pincodeInput({
        inputs: 6,
        hidedigits: false,
        complete: function (value, e, errorElement) {
            $j('#registry-submit-otp').off('click');
            // Check the OTP
            $j('#registry-submit-otp').on('click', function (event) {
                var data = {
                    'otpCode': value,
                    'customer_id': $j('#customer_id_register').val()
                };
                var message = '';
                $j('.load-otp-register').show();
                $j('#error-register-otp').html('');
                $j.ajax({
                    url: "<?php echo Mage::getUrl('authentication/otp/checkRegister');?>",
                    type: "post",
                    dataType: 'json',
                    data: data,
                    success: function (response) {
                        if (response.status === 'right_otp') {
                            // IF true
                            window.location.href =
                                '<?php echo $this->getUrl('*/*/*', ['_current' => true,
                                    '_use_rewrite' => true, '_store' => Mage::app()->getStore()->getId()]); ?>';
                        }
                        else if (response.status === 'wrong_otp') {
                            message = ("Mã xác nhận không chính xác!");
                            $j('.load-otp-register').show();
                            $j('#error-register-otp').html(message);
                        }
                    }
                });
                event.stopPropagation();
                event.preventDefault();
            })
        }
    });

    $j('#register-resend').on('click', function (e) {
        var data = {
            'customer_id': $j('#customer_id_register').val()
        };
        $j.ajax({
            url: "<?php echo Mage::getUrl('authentication/otp/resendSms');?>",
            type: "post",
            dataType: 'json',
            data: data,
            success: function (response) {
                if (response.status === 'over_sms') {
                    overSendSms();
                }
                else {
                    $j('#error-register-otp').html("");
                    return false;
                }
            }
        });
        e.preventDefault();
        e.stopPropagation();
    });

    function handleEnterRegister(e) {
        if (e.keyCode === 13) {
            handleRegister();
            e.preventDefault();
            e.stopPropagation();
        }
    }

    $j("#register-submit").on('click', function (e) {
        handleRegister();
        e.preventDefault();
        e.stopPropagation();
    });
    /** End register **/

    /** Forget password **/
    $j('.openLoginMd').on('click', function (e) {
        $j('#forgetPassword').modal('hide');
        $j('body').removeClass('modal-open');
        $j('#loginModal').modal();
    });

    $j('.forgot-password').on('click', function (e) {
        $j('#loginModal').modal('hide');
        $j('body').removeClass('modal-open');
        $j('#forgetPassword').modal();
        e.preventDefault();
        e.stopPropagation();
    });

    $j('#otp-confirm').pincodeInput({
        inputs: 6,
        hidedigits: false,
        complete: function (value, e, errorElement) {
            $j('#repassword-submit-otp').off('click');
            // Check the OTP
            $j('#repassword-submit-otp').on('click', function (event) {
                var data = {
                    'otpCode': value,
                    'customer_id': $j('#customer_id_otp').val()
                };
                var message = '';
                $j('.load-otp1').show();
                $j('#error-forget-otp').html('');
                $j.ajax({
                    url: "<?php echo Mage::getUrl('authentication/otp/check');?>",
                    type: "post",
                    dataType: 'json',
                    data: data,
                    success: function (response) {
                        if (response.status === 'right_otp') {
                            // IF true
                            $j('#customer_id_reset').val(response.customer_id);
                            $j('.load-otp1').hide();
                            $j('#otp-form').fadeOut(100);
                            $j('#forget-title').html("Nhập lại mật khẩu");
                            $j("#passwordConfirmForm").delay(100).fadeIn(100);
                        }
                        else if (response.status === 'wrong_otp') {
                            $j('.load-otp1').hide();
                            message = ("Mã xác nhận không chính xác!");
                            $j('#error-forget-otp').html(message);
                        }
                    }
                });
                event.stopPropagation();
                event.preventDefault();
            })
        }
    });

    function handleResetPw() {
        var password = $j('#re-password').val();
        var confirmPass = $j('#reconfirm-password').val();
        var customer_id = $j('#customer_id_reset').val();
        var message = '';
        if (password.length < 8) {
            message = (" Mật khẩu tối thiểu phải 8 ký tự");
            $j('#error-reset-password').html(message);
            return false;
        }
        if (password !== confirmPass) {
            message = ("Mật khẩu nhập lại không khớp!");
            $j('#error-reset-password').html(message);
            return false;
        }
        var data = {
            'password': password,
            'customer_id': customer_id
        };
        $j('.load-forget-pass').show();
        $j.ajax({
            url: "<?php echo Mage::getUrl('authentication/password/reset');?>",
            type: "post",
            dataType: 'json',
            data: data,
            success: function (response) {
                if (response.status === 'signed') {
                    window.location.href =
                        '<?php echo $this->getUrl('*/*/*', ['_current' => true,
                            '_use_rewrite' => true, '_store' => Mage::app()->getStore()->getId()]); ?>';
                }
            }
        });
    }

    function handleEnterResetPw(e) {
        if (e.keyCode === 13) {
            handleResetPw();
            e.stopPropagation();
            e.preventDefault();
            return true;
        }
    }

    $j('#repassword-submit').on('click', function (e) {
        handleResetPw();
        e.stopPropagation();
        e.preventDefault();
    });

    function handleForgetPw() {
        var telephone = $j('#telephone-forget').val();
        if (!/^(84|0)(1\d{9}|9\d{8}|8\d{8})$/.test(telephone)) {
            message = ("Số điện thoại không hợp lệ!");
            $j('#error-forget').html(message);
            return false;
        } else {
            $j('#forget-submit').prop('disable', true);
            //Send number to server
            var data = {
                'telephone': telephone
            };
            var message = '';
            $j(".load-forget").show();
            $j.ajax({
                url: "<?php echo Mage::getUrl('authentication/password/forget');?>",
                type: "post",
                dataType: 'json',
                data: data,
                success: function (response) {
                    if (response.status === 'not_exist_customer') {
                        message = ("Số điện thoại không có trong hệ thống!");
                        $j(".load-forget").hide();
                        $j('#error-forget').html(message);
                        $j('#forget-submit').prop('disable', false);
                        return false;
                    }
                    else if (response.status === 'true') {
                        $j('#customer_id_otp').val(response.customer_id);
                        $j(".load-forget").hide();
                        $j('#error-forget').html("");
                        $j("#otp-form").delay(100).fadeIn(100);
                        $j("#forget-tele-show").html(telephone);
                        $j('#forget-name-show').html(response.name);
                        $j("#telephone-form").fadeOut(100);
                    }
                    else {
                        overSendSms();
                    }
                }
            });
        }
    }

    function handleEnterForget(e) {
        if (e.keyCode === 13) {
            handleForgetPw();
            e.stopPropagation();
            e.preventDefault();
        }
    }

    $j('#forget-submit').on('click', function (e) {
        handleForgetPw();
        e.stopPropagation();
        e.preventDefault();
    });
    /** End forget password **/

    /** For link accout **/
    function handleLink() {
        var telephone = $j('#link-telephone').val();
        var message = '';
        if (!/^(84|0)(1\d{9}|9\d{8}|8\d{8})$/.test(telephone)) {
            message = ("Số điện thoại không hợp lệ!");
            $j('#error-link').html(message);
            return false;
        } else {
            // Check telephone
            var data = {
                'telephone': telephone
            };
            $j('.load-link').show();
            $j.ajax({
                url: "<?php echo Mage::getUrl('authentication/linked/index');?>",
                type: "post",
                dataType: 'json',
                data: data,
                success: function (response) {
                    if (response.status === 'order_not_exist') {
                        message = ("Số điện thoại không có đơn hàng nào trong hệ thống!");
                        $j('.load-link').hide();
                        $j('#error-link').html(message);
                        $j('#link-submit').prop('disabled', false);
                        return false;
                    }
                    else if (response.status === 'phone_exist') {
                        message = ("Số điện thoại có người sử dụng!");
                        $j('.load-link').hide();
                        $j('#error-link').html(message);
                        $j('#link-submit').prop('disabled', false);
                        return false;
                    }
                    else if (response.status === 'phone_linked') {
                        message = ("Số điện thoại đã được sử dụng để liên kết!");
                        $j('.load-link').hide();
                        $j('#error-link').html(message);
                        $j('#link-submit').prop('disabled', false);
                        return false;
                    }
                    else if (response.status === 'allow_link' || response.status === 'not_active') {
                        // If telephone existed
                        $j('#customer_id_otp_link').val(response.customer_id);
                        $j('#loginModal').modal('hide');
                        $j('body').removeClass('modal-open');
                        $j('#linkTele').html(telephone);
                        $j("#linkAcc-telephone").val(telephone);
                        $j('.load-link').hide();
                        $j('#link-submit').prop('disabled', false);
                        if (!$j("#link-otp-form").is(":visible")) {
                            $j("#link-update-form").fadeOut(100);
                            $j('#link-otp-form').fadeIn(100);
                        }
                        $j('#linkAccountModal').modal();
                    }
                }
            });
        }
    }

    function handleEnterLink(event) {
        if (event.keyCode === 13) {
            handleLink();
            event.preventDefault();
            event.stopPropagation();
            return true;
        }
    }

    $j('#link-submit').on('click', function (e) {
        handleLink();
        e.preventDefault();
        e.stopPropagation();
    });

    $j('#link-otp').pincodeInput({
        inputs: 6,
        hidedigits: false,
        complete: function (value, e, errorElement) {
            $j('#linkAcc-submit-otp').off('click');
            // Check the OTP
            $j('#linkAcc-submit-otp').on('click', function (event) {
                var message = '';
                $j('#error-linkAcc').html(message);
                var data = {
                    'otpCode': value,
                    'customer_id': $j('#customer_id_otp_link').val()
                };

                $j.ajax({
                    url: "<?php echo Mage::getUrl('authentication/otp/check');?>",
                    type: "post",
                    dataType: 'json',
                    data: data,
                    success: function (response) {
                        if (response.status === 'right_otp') {
                            // IF true
                            $j('#customer_id_link').val(response.customer_id);
                            $j("#link-otp-form").fadeOut(100);
                            $j('#link-update-form').delay(100).fadeIn(100);
                        }
                        else {
                            message = ("Mã xác nhận không chính xác!");
                            $j('#error-linkAcc').html(message);
                        }
                    }
                });
                event.preventDefault();
                event.stopPropagation();
            })
        }
    });

    function handleSubmitLink() {
        var name = $j("#linkAcc-name").val();
        var password = $j("#linkAcc-password").val();
        var confirmPassword = $j('#linkAcc-confirmPassword').val();
        var telephone = $j("#linkAcc-telephone").val();
        var email = $j('#linkAcc-email').val();
        var message = "";
        if (name && email) {
            if (!/[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/.test(email)) {
                message = ("Địa chỉ Email không hợp lệ!");
                $j('.load-otp2').hide();
                $j('#error-link-update').html(message);
                return false;
            }
            if (password.length < 8) {
                message = (" Mật khẩu tối thiểu phải 8 ký tự");
                $j('.load-otp2').hide();
                $j('#error-link-update').html(message);
                return false;
            }
            if (password !== confirmPassword) {
                message = ("Mật khẩu nhập lại không khớp!");
                $j('.load-otp2').hide();
                $j('#error-link-update').html(message);
                return false;
            }
            // Update Information
            var data = {
                'name': name,
                'password': password,
                'email': email,
                'telephone': telephone,
                'customer_id': $j('#customer_id_link').val()
            };
            $j('.load-otp2').show();
            $j.ajax({
                url: "<?php echo Mage::getUrl('authentication/user/update');?>",
                type: "post",
                dataType: 'json',
                data: data,
                success: function (response) {
                    window.location.href =
                        '<?php echo $this->getUrl('*/*/*', ['_current' => true,
                            '_use_rewrite' => true, '_store' => Mage::app()->getStore()->getId()]); ?>';
                }
            });
        } else {
            message = "Vui lòng nhập đầy đủ các trường";
            $j('.load-otp2').hide();
            $j("#error-link-update").html(message);
        }
    }

    function handleEnterSubmitLink(event) {
        if (event.keyCode === 13) {
            handleSubmitLink();
            event.preventDefault();
            event.stopPropagation();
            return true;
        }
    }

    $j('#linkAcc-submit').on('click', function (e) {
        handleSubmitLink();
        e.preventDefault();
        e.stopPropagation();
    });

    $j('#linkAcc-resend').on('click', function (e) {
        var data = {
            'customer_id': $j('#customer_id_otp_link').val()
        };
        $j.ajax({
            url: "<?php echo Mage::getUrl('authentication/otp/resendSms');?>",
            type: "post",
            dataType: 'json',
            data: data,
            success: function (response) {
                if (response.status === 'over_sms') {
                    overSendSms();
                }
                else {
                    $j('#error-linkAcc').html("");
                    return false;
                }
            }
        });
        e.preventDefault();
        e.stopPropagation();
    });
    /** End link accout **/

    /** For login Facebook **/
    function otpForFB(id, name) {
        $j('#loginModal').modal('hide');
        $j('body').removeClass('modal-open');
        $j('#fbname').html(name);
        $j('#inputFb').val(id);
        $j('#registryfb-name').val(name);
        $j('#loginModal').toggle();
        $j('#loginFBModal').modal();
    }

    function checkLoginState() {
        if (responseFb.status === 'connected') {
            FB.api('/me', {fields: 'id, name'}, function (response) {
                var data = {
                    'fbid': response.id
                };
                $j.ajax({
                    url: "<?php echo Mage::getUrl('authentication/facebook/login');?>",
                    type: "post",
                    dataType: 'json',
                    data: data,
                    success: function (response_ajax) {
                        if (response_ajax.status === 'email_is_not_exist' ||
                            response_ajax.status === 'phone_not_active') {
                            otpForFB(response.id, response.name);
                        }
                        else {
                            window.location.href =
                                '<?php echo $this->getUrl('*/*/*', ['_current' => true,
                                    '_use_rewrite' => true, '_store' => Mage::app()->getStore()->getId()]); ?>';
                        }
                    }
                });
            });
        }
        else {
            FB.login(function (response_login) {
                if (response_login.status === 'connected') {
                    FB.api('/me', {fields: 'id, name'}, function (response) {
                        var data = {
                            'fbid': response.id
                        };
                        $j.ajax({
                            url: "<?php echo Mage::getUrl('authentication/facebook/checkRegister');?>",
                            type: "post",
                            dataType: 'json',
                            data: data,
                            success: function (response_ajax) {
                                if (response_ajax.status === 'exist') {
                                    $j.ajax({
                                        url: "<?php echo Mage::getUrl('authentication/facebook/login');?>",
                                        type: "post",
                                        dataType: 'json',
                                        data: data,
                                        success: function (response_ajax) {
                                            if (response_ajax.status === 'email_is_not_exist' ||
                                                response_ajax.status === 'phone_not_active') {
                                                otpForFB(response.id, response.name);
                                            }
                                            else {
                                                window.location.href =
                                                    '<?php echo $this->getUrl('*/*/*', ['_current' => true,
                                                        '_use_rewrite' => true, '_store' => Mage::app()->getStore()->getId()]); ?>';
                                            }
                                        }
                                    });
                                }
                                else {
                                    var name = response.name;
                                    var id = response.id;
                                    otpForFB(id, name);
                                }
                            }
                        });
                    });
                }
            }, {scope: 'public_profile, email'});
        }
    }

    function handleLoginFb(event) {
        if (event.keyCode === 13) {
            pushTelephoneNumber();
            event.preventDefault();
            event.stopPropagation();
            return true;
        }
    }

    // Validate the form
    function pushTelephoneNumber() {
        var telephone = $j('#fb-login-telephone').val();
        var name = $j('#registryfb-name').val();
        var message = '';
        if (telephone) {
            if (!/^(84|0)(1\d{9}|9\d{8}|8\d{8})$/.test(telephone)) {
                message = ("Số điện thoại không hợp lệ!");
                $j('#error-confirm-facebook').html(message);
                return false;
            }
            else {
                var id = $j('#inputFb').val();
                var data = {
                    'fbid': id,
                    'telephone': telephone,
                    'name': name
                };
                $j('.update-profile-load').show();
                $j.ajax({
                    url: "<?php echo Mage::getUrl('authentication/facebook/register');?>",
                    type: "post",
                    dataType: 'json',
                    data: data,
                    success: function (response) {
                        if (response.status === "phone_existed") {
                            message = ("Số điện thoại đã có người sử dụng. Vui lòng nhập số điện thoại khác!");
                            $j('.update-profile-load-fb').hide();
                            $j('#error-confirm-facebook').html(message);
                        }
                        else if (response.status === "over_sms") {
                            overSendSms();
                        }
                        else {
                            $j('.fb-confirm-header').html('');
                            $j('#fbOtpTele').html(telephone);
                            $j('#customer_id_otp_fb').val(response.customer_id);
                            $j('#fb_id_otp').val(id);
                            $j('.fb-update-profile').fadeOut(100);
                            $j("#confirm-fb-otp").delay(100).fadeIn(100);
                        }

                    }
                });
            }
        } else {
            message = "Vui lòng nhập đầy đủ các trường";
            $j('#error-confirm-facebook').html(message);
            return false;
        }
    }

    $j('#registryfb-otp').pincodeInput({
        inputs: 6,
        hidedigits: false,
        complete: function (value, e, errorElement) {
            $j('#loginFb-submit-otp').off('click');
            // Check the OTP
            $j('#loginFb-submit-otp').on('click', function () {
                var data = {
                    'otpCode': value,
                    'customer_id': $j('#customer_id_otp_fb').val(),
                    'fb_id': $j('#fb_id_otp').val()
                };
                var message = '';
                $j.ajax({
                    url: "<?php echo Mage::getUrl('authentication/otp/checkAndLogin');?>",
                    type: "post",
                    dataType: 'json',
                    data: data,
                    success: function (response) {
                        if (response.status === 'right_otp') {
                            window.location.href =
                                '<?php echo $this->getUrl('*/*/*', ['_current' => true,
                                    '_use_rewrite' => true, '_store' => Mage::app()->getStore()->getId()]); ?>';
                        }
                        else {
                            message = ("Mã xác nhận không chính xác!");
                            $j('#error-confirm-facebook-otp').html(message);
                        }
                    }
                });
            });
        }
    });

    $j('#loginFb-resend').on('click', function (e) {
        var data = {
            'customer_id': $j('#customer_id_otp_fb').val()
        };
        $j.ajax({
            url: "<?php echo Mage::getUrl('authentication/otp/resendSms');?>",
            type: "post",
            dataType: 'json',
            data: data,
            success: function (response) {
                if (response.status === 'over_sms') {
                    overSendSms();
                }
                else {
                    $j('#error-confirm-facebook').html("");
                    return false;
                }
            }
        });
        e.preventDefault();
        e.stopPropagation();
    });
    /** End login Facebook **/

    function overSendSms() {
        swal({
            title: "Bạn cần được hỗ trợ",
            text: "Nếu bạn vẫn chưa nhận được mã xác nhận, vui lòng liên hệ tổng đài <b>19001232</b> để được hỗ trợ!",
            type: "warning",
            showCancelButton: false,
            showConfirmButton: true,
            confirmButtonColor: "#f7701e",
            confirmButtonText: "Đóng",
            closeOnConfirm: false,
            animation: "slide-from-top",
            html: true
        }, function (isConfirm) {
            if (isConfirm) {
                window.location.href =
                    '<?php echo $this->getUrl('*/*/*', ['_current' => true,
                        '_use_rewrite' => true, '_store' => Mage::app()->getStore()->getId()]); ?>';
            }
        });
    }
</script>
